name: Monday Product Change Log (Merged PRs)

on:
  pull_request:
    types: [closed]

jobs:
  post_to_monday:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Create Monday item and formatted update
        env:
          MONDAY_API_TOKEN: ${{ secrets.MONDAY_API_TOKEN }}
          MONDAY_BOARD_ID: ${{ secrets.MONDAY_PRODUCT_CHANGE_LOG_BOARD_ID }}

          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_URL: ${{ github.event.pull_request.html_url }}

          AUTHOR_LOGIN: ${{ github.event.pull_request.user.login }}
          GH_TOKEN: ${{ github.token }}

        run: |
          set -euo pipefail

          # Resolve author name
          AUTHOR_NAME=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/users/$AUTHOR_LOGIN" | jq -r '.name')

          if [ -z "$AUTHOR_NAME" ] || [ "$AUTHOR_NAME" = "null" ]; then
            AUTHOR_NAME="$AUTHOR_LOGIN"
          fi

          # Build Monday column values
          COLUMN_VALUES=$(jq -n \
            --arg author "$AUTHOR_NAME" \
            --arg product "Contact Centre" \
            '{
              text_mkv394b9: $author,
              dropdown_mm0m14q0: { labels: [$product] }
            }' | jq -c .)

          # Create Monday item
          CREATE_ITEM_PAYLOAD=$(jq -n \
            --arg query 'mutation ($boardId: ID!, $itemName: String!, $columnVals: JSON!) { create_item(board_id: $boardId, item_name: $itemName, column_values: $columnVals) { id } }' \
            --arg boardId "$MONDAY_BOARD_ID" \
            --arg itemName "$PR_TITLE" \
            --arg columnVals "$COLUMN_VALUES" \
            '{query: $query, variables: {boardId: $boardId, itemName: $itemName, columnVals: $columnVals}}')

          CREATE_ITEM_RESP=$(curl -s -X POST https://api.monday.com/v2 \
            -H "Authorization: $MONDAY_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$CREATE_ITEM_PAYLOAD")

          ITEM_ID=$(echo "$CREATE_ITEM_RESP" | jq -r '.data.create_item.id')

          if [ -z "$ITEM_ID" ] || [ "$ITEM_ID" = "null" ]; then
            echo "Failed to create Monday item"
            echo "$CREATE_ITEM_RESP"
            exit 1
          fi

          # Ensure PR body exists
          if [ -z "${PR_BODY:-}" ] || [ "$PR_BODY" = "null" ]; then
            PR_BODY="No description provided."
          fi

          # Remove markdown heading markers
          CLEAN_BODY=$(echo "$PR_BODY" | sed -E 's/^#+[[:space:]]*//g')

          # Convert Markdown to tight HTML
          HTML_BODY=$(echo "$CLEAN_BODY" | awk '
          BEGIN { in_list=0 }
          {
            # Section headers (Overview, Objectives, etc.)
            if ($0 ~ /^[A-Za-z ]+$/ && length($0) < 60) {
              if (in_list==1) { print "</ul>"; in_list=0 }
              print "<h2 style=\"margin:18px 0 6px 0;\">" $0 "</h2>"
              next
            }

            # Checked checklist
            if ($0 ~ /^- \[[xX]\] /) {
              if (in_list==1) { print "</ul>"; in_list=0 }
              sub(/^- \[[xX]\] /, "")
              print "<p style=\"margin:2px 0;\">&#10004; " $0 "</p>"
              next
            }

            # Unchecked checklist
            if ($0 ~ /^- \[ \] /) {
              if (in_list==1) { print "</ul>"; in_list=0 }
              sub(/^- \[ \] /, "")
              print "<p style=\"margin:2px 0; color:#999;\">&#9633; " $0 "</p>"
              next
            }

            # Standard bullet list
            if ($0 ~ /^- /) {
              if (in_list==0) { print "<ul style=\"margin:6px 0; padding-left:18px;\">"; in_list=1 }
              sub(/^- /, "")
              print "<li style=\"margin:4px 0;\">" $0 "</li>"
              next
            }

            # Skip blank lines to remove spacing bloat
            if (length($0)==0) {
              next
