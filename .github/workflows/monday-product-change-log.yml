name: Monday Product Change Log (Merged PRs)

on:
  pull_request:
    types: [closed]

jobs:
  post_to_monday:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Create Monday item and formatted update
        env:
          MONDAY_API_TOKEN: ${{ secrets.MONDAY_API_TOKEN }}
          MONDAY_BOARD_ID: ${{ secrets.MONDAY_PRODUCT_CHANGE_LOG_BOARD_ID }}

          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_URL: ${{ github.event.pull_request.html_url }}

          AUTHOR_LOGIN: ${{ github.event.pull_request.user.login }}
          GH_TOKEN: ${{ github.token }}

        run: |
          set -euo pipefail

          # Resolve author display name
          AUTHOR_NAME=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/users/$AUTHOR_LOGIN" | jq -r '.name')

          if [ -z "$AUTHOR_NAME" ] || [ "$AUTHOR_NAME" = "null" ]; then
            AUTHOR_NAME="$AUTHOR_LOGIN"
          fi

          # Build column values JSON
          COLUMN_VALUES=$(jq -n \
            --arg author "$AUTHOR_NAME" \
            --arg product "Contact Centre" \
            '{
              text_mkv394b9: $author,
              dropdown_mm0m14q0: { labels: [$product] }
            }')

          # Create Monday item
          CREATE_ITEM_PAYLOAD=$(jq -n \
            --arg query 'mutation ($boardId: ID!, $itemName: String!, $columnVals: JSON!) { create_item(board_id: $boardId, item_name: $itemName, column_values: $columnVals) { id } }' \
            --arg boardId "$MONDAY_BOARD_ID" \
            --arg itemName "$PR_TITLE" \
            --arg columnVals "$COLUMN_VALUES" \
            '{query: $query, variables: {boardId: $boardId, itemName: $itemName, columnVals: $columnVals}}')

          CREATE_ITEM_RESP=$(curl -s -X POST https://api.monday.com/v2 \
            -H "Authorization: $MONDAY_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$CREATE_ITEM_PAYLOAD")

          ITEM_ID=$(echo "$CREATE_ITEM_RESP" | jq -r '.data.create_item.id')

          if [ -z "$ITEM_ID" ] || [ "$ITEM_ID" = "null" ]; then
            echo "Failed to create Monday item"
            echo "$CREATE_ITEM_RESP"
            exit 1
          fi

          # Ensure PR body exists
          if [ -z "${PR_BODY:-}" ] || [ "$PR_BODY" = "null" ]; then
            PR_BODY="No description provided."
          fi

          # Clean PR body:
          # - Remove Copilot HTML comments block (if present)
          # - Remove '---' separators
          # - Remove CRLF
          # - Collapse multiple blank lines
          CLEAN_BODY=$(echo "$PR_BODY" \
            | sed '/<!--/,/-->/d' \
            | sed '/^---$/d' \
            | sed 's/\r//g' \
            | awk 'NF{blank=0} !NF{blank++} blank<2')

          # Convert Markdown -> compact HTML
          # Strategy:
          # - "# Heading" -> bold line (no h2 margins)
          # - "- [x]/[ ]" -> ✓ / ☐
          # - "- bullet" (and "  - bullet") -> • bullet (no ul padding)
          # - Everything else -> normal div line
          HTML_BODY=$(echo "$CLEAN_BODY" | awk '
          {
            if ($0 ~ /^# /) {
              sub(/^# /, "")
              print "<div><strong>" $0 "</strong></div>"
              next
            }

            if ($0 ~ /^- \[[xX]\] /) {
              sub(/^- \[[xX]\] /, "")
              print "<div>✓ " $0 "</div>"
              next
            }

            if ($0 ~ /^- \[ \] /) {
              sub(/^- \[ \] /, "")
              print "<div>☐ " $0 "</div>"
              next
            }

            if ($0 ~ /^  - /) {
              sub(/^  - /, "")
              print "<div style=\"margin-left:12px;\">• " $0 "</div>"
              next
            }

            if ($0 ~ /^- /) {
              sub(/^- /, "")
              print "<div>• " $0 "</div>"
              next
            }

            if (length($0)==0) { next }

            print "<div>" $0 "</div>"
          }')

          # Final HTML block (compact, still clearly titled)
          FINAL_HTML="<div><strong>Pull Request</strong></div><div><a href=\"$PR_URL\">$PR_URL</a></div><div></div>$HTML_BODY"

          # Send update
          CREATE_UPDATE_PAYLOAD=$(jq -n \
            --arg query 'mutation ($itemId: ID!, $body: String!) { create_update(item_id: $itemId, body: $body) { id } }' \
            --arg itemId "$ITEM_ID" \
            --arg body "$FINAL_HTML" \
            '{query: $query, variables: {itemId: $itemId, body: $body}}')

          CREATE_UPDATE_RESP=$(curl -s -X POST https://api.monday.com/v2 \
            -H "Authorization: $MONDAY_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$CREATE_UPDATE_PAYLOAD")

          UPDATE_ID=$(echo "$CREATE_UPDATE_RESP" | jq -r '.data.create_update.id')

          if [ -z "$UPDATE_ID" ] || [ "$UPDATE_ID" = "null" ]; then
            echo "Failed to create Monday update"
            echo "$CREATE_UPDATE_RESP"
            exit 1
          fi

          echo "Monday item created and update added successfully."
